<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SnapPaws Scavenger</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap');
        
        body {
            font-family: 'Quicksand', sans-serif;
            background-color: #f0f9ff;
            color: #1e293b;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            margin: 0;
        }

        #camera-container {
            position: fixed;
            inset: 0;
            z-index: 0;
        }
        #camera-stream {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #shutter-flash {
            position: fixed;
            inset: 0;
            background: white;
            opacity: 0;
            z-index: 50;
            pointer-events: none;
        }
        .flash-active {
            animation: flash-anim 0.3s ease-out;
        }
        @keyframes flash-anim {
            0% { opacity: 0.8; }
            100% { opacity: 0; }
        }

        #cat-wrapper {
            position: relative;
            width: 180px;
            height: 180px;
            margin: 0 auto;
            filter: drop-shadow(0 0 20px rgba(255, 255, 255, 0.9));
        }
        
        #cat-face {
            width: 100%;
            height: 100%;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            background-image: url('https://i.postimg.cc/Dzr4xMWf/Gemini-Generated-Image-c4btfec4btfec4bt-removebg-preview.png');
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .speaking #cat-face {
            background-image: url('https://i.postimg.cc/QCr6RPmY/Gemini-Generated-Image-nzqkernzqkernzqk-removebg-preview.png');
            transform: scale(1.1) rotate(5deg);
        }

        .shiny-panel {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(15px);
            border: 2px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
            border-radius: 2.5rem;
        }

        .shiny-text {
            background: linear-gradient(45deg, #3b82f6, #a855f7, #ec4899);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 800;
        }

        .camera-btn {
            background: linear-gradient(135deg, #60a5fa, #a78bfa);
            box-shadow: 0 10px 25px rgba(96, 165, 250, 0.4);
            transition: all 0.2s;
        }
        .camera-btn:active {
            transform: scale(0.9) translateY(4px);
        }
    </style>
</head>
<body class="flex flex-col">

    <div id="shutter-flash"></div>

    <div id="camera-container">
        <video id="camera-stream" autoplay playsinline></video>
    </div>

    <div id="game-ui" class="relative z-10 flex flex-col h-full pointer-events-none p-6">
        <div class="flex flex-col items-center mt-2">
            <div id="cat-wrapper">
                <div id="cat-face"></div>
            </div>
            <div id="speech-bubble" class="mt-2 shiny-panel px-6 py-3 max-w-[280px] text-center font-bold text-slate-700 opacity-0 transition-opacity duration-300">
                "Hi!"
            </div>
        </div>

        <div class="flex justify-between mt-auto mb-4 px-2">
            <div class="shiny-panel p-3 min-w-[100px] text-center">
                <p class="text-[10px] uppercase font-bold text-blue-500">تم العثور</p>
                <p id="score-display" class="text-xl font-bold">0/10</p>
            </div>
            <div class="shiny-panel p-3 min-w-[100px] text-center">
                <p class="text-[10px] uppercase font-bold text-pink-500">الوقت</p>
                <p id="timer-display" class="text-xl font-bold font-mono">45s</p>
            </div>
        </div>

        <div class="shiny-panel p-6 text-center mb-4 pointer-events-auto">
            <p class="text-blue-500 font-bold uppercase tracking-widest text-xs mb-1">هل يمكنك العثور على...</p>
            <h2 id="target-item" class="shiny-text text-4xl leading-tight">---</h2>
        </div>

        <div class="flex justify-center mb-6">
            <button id="capture-btn" onclick="captureAndVerify()" class="camera-btn w-20 h-20 rounded-full flex items-center justify-center p-1 pointer-events-auto">
                <div class="w-full h-full border-4 border-white/40 rounded-full flex items-center justify-center">
                    <div class="w-6 h-6 bg-white rounded-full"></div>
                </div>
            </button>
        </div>
    </div>

    <div id="start-overlay" class="fixed inset-0 z-[100] bg-white flex flex-col items-center justify-center p-10 text-center">
        <img src="https://i.postimg.cc/Dzr4xMWf/Gemini-Generated-Image-c4btfec4btfec4bt-removebg-preview.png" class="w-48 h-48 mb-6 animate-bounce" alt="Cat">
        <h1 class="text-5xl font-black shiny-text mb-2">SnapPaws!</h1>
        <p class="text-slate-500 font-semibold mb-10">أرني الأشياء لأحبك!</p>
        <button onclick="startGame()" class="camera-btn px-12 py-5 text-white font-bold rounded-full text-xl hover:scale-105 transition-transform">
            ابدأ اللعب
        </button>
    </div>

    <div id="modal" class="hidden fixed inset-0 z-[110] bg-white/90 backdrop-blur-md flex items-center justify-center p-6">
        <div class="shiny-panel w-full max-w-sm p-10 text-center">
            <h2 id="modal-title" class="text-4xl font-black mb-4 shiny-text">YAY!</h2>
            <p id="modal-body" class="text-slate-600 mb-8 text-lg font-medium"></p>
            <button onclick="location.reload()" class="camera-btn w-full py-5 text-white font-bold rounded-full text-xl">العب مجدداً</button>
        </div>
    </div>

    <canvas id="capture-canvas" class="hidden"></canvas>

    <script>
        const apiKey = "AIzaSyDqNxEulNMBJ36TP49uZhqtHHJfjd9Ik2w";
        const video = document.getElementById('camera-stream');
        const canvas = document.getElementById('capture-canvas');
        const catWrapper = document.getElementById('cat-wrapper');
        const speechBubble = document.getElementById('speech-bubble');
        const flashOverlay = document.getElementById('shutter-flash');
        
        let items = ["Mug", "Pillow", "Shoe", "Fruit", "Remote Control", "Plant", "Key", "Spoon", "Book", "Chair"];
        let availableItems = [...items];
        let score = 0;
        let timeLeft = 45;
        let timerId = null;
        let isProcessing = false;

        const synth = window.speechSynthesis;
        let voices = [];
        
        function loadVoices() { voices = synth.getVoices(); }
        loadVoices();
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = loadVoices;
        }

        function speak(text) {
            synth.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.voice = voices.find(v => v.lang.includes('en-US')) || voices[0];
            utterance.pitch = 2.0; 
            utterance.rate = 1.1;

            utterance.onstart = () => {
                catWrapper.classList.add('speaking');
                speechBubble.innerText = `"${text}"`;
                speechBubble.style.opacity = 1;
            };
            utterance.onend = () => {
                catWrapper.classList.remove('speaking');
                setTimeout(() => { if(!synth.speaking) speechBubble.style.opacity = 0; }, 2000);
            };
            synth.speak(utterance);
        }

        async function startGame() {
            document.getElementById('start-overlay').classList.add('hidden');
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                video.srcObject = stream;
                speak("Hi! I'm so excited! Let's find some stuff!");
                nextRound();
            } catch (e) {
                alert("يرجى تفعيل الكاميرا للعب!");
            }
        }

        function nextRound() {
            if (availableItems.length === 0) {
                endGame("PURR-FECT!", "You found everything! You're the best!");
                return;
            }
            const idx = Math.floor(Math.random() * availableItems.length);
            const currentItem = availableItems[idx];
            availableItems.splice(idx, 1);
            document.getElementById('target-item').innerText = currentItem;
            document.getElementById('score-display').innerText = `${score}/${items.length}`;
            speak(`Can you find a ${currentItem} for me?`);
            timeLeft = 45;
            if (timerId) clearInterval(timerId);
            timerId = setInterval(() => {
                timeLeft--;
                document.getElementById('timer-display').innerText = `${timeLeft}s`;
                if (timeLeft <= 0) endGame("Zzzzz...", "I'm too sleepy now. Try again?");
            }, 1000);
        }

        async function fetchWithRetry(url, options, maxRetries = 5) {
            let delay = 1000;
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const res = await fetch(url, options);
                    if (res.ok) return await res.json();
                    if (res.status === 429 || res.status >= 500) {
                        // Rate limit or server error, wait and retry
                    } else {
                        const errorData = await res.json();
                        throw new Error(errorData.error?.message || "Request failed");
                    }
                } catch (e) {
                    if (i === maxRetries - 1) throw e;
                }
                await new Promise(resolve => setTimeout(resolve, delay));
                delay *= 2; // Exponential backoff
            }
        }

        async function captureAndVerify() {
            if (isProcessing) return;
            isProcessing = true;
            
            // Flash effect
            flashOverlay.classList.add('flash-active');
            setTimeout(() => flashOverlay.classList.remove('flash-active'), 300);

            const target = document.getElementById('target-item').innerText;
            const originalTargetText = target;
            document.getElementById('target-item').innerText = "جاري التحقق...";
            speak("Meow! Let me look...");

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);
            const base64 = canvas.toDataURL('image/jpeg', 0.5).split(',')[1];

            try {
                // Using 2.5-flash-preview as per newest standard instructions
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                
                const data = await fetchWithRetry(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ 
                            parts: [
                                { text: `Analyze this image. Is there a "${target}" visible? Answer only in JSON: {"found": boolean, "comment": "string"}` },
                                { inlineData: { mimeType: "image/jpeg", data: base64 } }
                            ] 
                        }],
                        generationConfig: { 
                            responseMimeType: "application/json"
                        }
                    })
                });
                
                if (data.candidates && data.candidates.length > 0 && data.candidates[0].content) {
                    const resultText = data.candidates[0].content.parts[0].text;
                    const result = JSON.parse(resultText);
                    
                    if (result.found) {
                        score++;
                        speak(result.comment || "Yay! You found it!");
                        nextRound();
                    } else {
                        document.getElementById('target-item').innerText = originalTargetText;
                        speak(result.comment || "Hmm, I don't see it yet. Try a better angle!");
                    }
                } else {
                    // Check if safety ratings blocked the response
                    const safetyReason = data.promptFeedback?.blockReason || "unknown safety reason";
                    throw new Error(`Gemini blocked the response: ${safetyReason}`);
                }
            } catch (e) {
                console.error("Gemini Error:", e);
                document.getElementById('target-item').innerText = originalTargetText;
                speak("My paws slipped! Please try taking the photo again.");
            } finally {
                isProcessing = false;
            }
        }

        function endGame(title, body) {
            clearInterval(timerId);
            document.getElementById('modal').classList.remove('hidden');
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-body').innerText = body;
            speak(body);
        }
    </script>
</body>
</html>